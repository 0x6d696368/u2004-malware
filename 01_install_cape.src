#!/bin/bash

apt install unzip git wget

adduser cape --disabled-password --gecos ""
usermod -a -G libvirt cape

# INSTALL LATEST MONGO DB 
wget -q https://www.mongodb.org/static/pgp/server-4.2.asc -O- | apt-key add -
echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.2 multiverse" | tee /etc/apt/sources.list.d/mongodb-org.list
apt update
apt install -y libpcre3-dev
apt install -y mongodb-org
pip3 install pymongo
systemctl --no-pager start mongod
systemctl --no-pager status mongod
systemctl --no-pager enable mongod

# INSTALL SURICATA
add-apt-repository ppa:oisf/suricata-stable
apt install -y suricata
suricata-update
sed 's/RUN=yes/RUN=no/g' -i /etc/default/suricata
systemctl --no-pager stop suricata
systemctl --no-pager disable suricata

# INSTALL yara 4
apt install -y autoconf libtool libjansson-dev libmagic1 libmagic-dev jq libssl-dev checkinstall
wget https://github.com/VirusTotal/yara/archive/v4.0.5.zip
unzip v4.0.5.zip
cd yara-4.0.5/
./bootstrap.sh
./configure --enable-cuckoo --enable-magic --enable-dotnet --enable-profiling
make -j8
make install
pip3 install git+https://github.com/VirusTotal/yara-python
rm -rf v4.0.5.zip yara-4.0.5

# INSTALL CAPEv2
cd /opt
git clone https://github.com/kevoreilly/CAPEv2/
#cd CAPEv2
#git checkout 155409d8a693f34ae307ea632070ebd191fbee63
#cd /opt
python3 CAPEv2/utils/community.py -afw
chown cape:cape -R /opt/CAPEv2

# FIXME: we don't have yara 4 yet
rm /opt/CAPEv2/data/yara/CAPE/Renamer.yar

# install dependencies TODO: minimize these
# cape
apt install -y python3-pip libre2-dev geoip-database libgeoip-dev libfuzzy-dev build-essential cmake ninja-build python3-dev cython3 pybind11-dev libre2-dev iptables psmisc jq sqlite3 tmux net-tools checkinstall graphviz python3-pydot git numactl python3 python3-dev python3-pip libjpeg-dev zlib1g-dev upx-ucl libssl-dev wget zip unzip p7zip-full rar unrar unace-nonfree cabextract geoip-database libgeoip-dev libjpeg-dev mono-utils ssdeep libfuzzy-dev exiftool ssdeep uthash-dev libconfig-dev libarchive-dev libtool autoconf automake privoxy software-properties-common wkhtmltopdf xvfb xfonts-100dpi tcpdump libcap2-bin python3-pil subversion uwsgi uwsgi-plugin-python3 python3-pyelftools git curl openvpn wireguard
apt install -y python3-django python3-pefile python3-gevent python3-matplotlib python3-xmltodict python3-dpkt p7zip-full rar unace-nonfree cabextract python3-tlsh
pip3 install -r /opt/CAPEv2/requirements.txt
#pip3 install flare-capa pyre2 unicorn capstone pymongo sqlalchemy dnspython volatility3 git+https://github.com/CAPESandbox/httpreplay oletools XLMMacroDeobfuscator imagehash sflock pycryptodome netstruct pype32-py3 pymisp
# cape-web
#pip3 install django-recaptcha django-ratelimit django-allauth django-otp django-crispy_forms pyzipper django-settings-export django-extensions
su cape -c "cd /opt/CAPEv2/web; python3 manage.py migrate"
# cape-processor
apt install -y python3-pebble
#pip3 install pydeep

# clamav
apt install -y clamdscan clamav-daemon clamav-freshclam clamav-unofficial-sigs
pip3 install pyclamd
usermod -a -G clamav cape
usermod -a -G cape clamav
systemctl --no-pager stop clamav-daemon
echo "/opt/CAPEv2/storage/** r," | sudo tee -a /etc/apparmor.d/local/usr.sbin.clamd
systemctl --no-pager reload apparmor

# allow tcpdump
groupadd pcap
usermod -a -G pcap cape
chgrp pcap /usr/sbin/tcpdump
setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump

# install tor
apt install -y tor
apt purge -y privoxy
cat | tee -a /etc/tor/torrc <<EOF
VirtualAddrNetworkIPv4 10.192.0.0/10
AutomapHostsOnResolve 1
TransPort 192.168.123.1:9040 IsolateClientAddr IsolateClientProtocol IsolateDestAddr IsolateDestPort
DNSPort 192.168.123.1:9053
EOF
systemctl --no-pager stop tor

# install inetsim
apt install -y inetsim
systemctl --no-pager stop inetsim

virsh net-define <<EOF
<network>
  <name>cape</name>
  <uuid>02d41a89-4ed1-4cfd-93e6-e69b6dd7cb8c</uuid>
  <forward mode='route'/>
  <bridge name='cape' stp='off' delay='0'/>
  <mac address='52:54:00:a2:16:33'/>
  <dns>
	<forwarder addr='192.168.125.1'/>
  </dns>
  <ip address='192.168.123.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.123.128' end='192.168.123.254'/>
      <host mac='52:54:00:e7:74:9d' name='f3uo35' ip='192.168.123.10'/>
    </dhcp>
  </ip>
  <route address='192.168.123.0' prefix='24' gateway='192.168.123.1'/>
</network>
EOF

#allow ftp
ufw allow from 192.168.123.10 to 192.168.123.1 port 66601
ufw allow from 192.168.123.10 to 192.168.123.1 port 66602

#allow agent
ufw allow from 192.168.123.10 to 192.168.123.1 port 2042
#allow tor
ufw allow from 192.168.123.10 to 192.168.123.1 port 9040
ufw allow from 192.168.123.10 to 192.168.123.1 port 9053
#allow inetsim
ufw allow from 192.168.123.10 to 192.168.124.1

sed 's/DEFAULT_FORWARD_POLICY="DROP"/DEFAULT_FORWARD_POLICY="ACCEPT"/g' -i /etc/default/ufw
sed 's|#net/ipv4/ip_forward=1|net/ipv4/ip_forward=1|g' -i /etc/ufw/sysctl.conf

#ufw disable && ufw --force enable
systemctl --no-pager restart ufw

# COPY CONFIGURATION FILES

chown +x /usr/local/sbin/cape

systemctl --no-pager daemon-reload

systemctl --no-pager start tor
systemctl --no-pager enable tor
systemctl --no-pager start inetsim
systemctl --no-pager enable inetsim
systemctl --no-pager start clamav-daemon
systemctl --no-pager enable clamav-daemon

systemctl --no-pager start cape{,-web,-processor,-rooter,-suricata}
systemctl --no-pager enable cape{,-web,-processor,-rooter,-suricata}

# prepare VM
pip3 install pyftpdlib

#wget https://www.python.org/ftp/python/3.9.0/python-3.9.0.exe
#wget https://files.pythonhosted.org/packages/26/b9/85a0932bbeaa0e3e29b3f90b09f6caf24dcbbc153f5e5b87c6645b44d21c/Pillow-8.0.1-cp39-cp39-win32.whl
# python3 -m pyftpdlib -p 66601 -r 66602-66602
# ftp://192.168.123.1:66601
# install: python-3.9.0.exe
# PowerShell as Admin: pip3 Pillow...whl

# Test for leaks:
# tcpdump -i eno1 -nvvvv not port $(echo $SSH_CONNECTION | cut -d' ' -f4) and src $(hostname -I | cut -d' ' -f1) and not icmp and not dst  port https

