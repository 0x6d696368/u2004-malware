#!/bin/bash

GHIDRA_URL="https://ghidra-sre.org/ghidra_9.2.2_PUBLIC_20201229.zip"
GHIDRA_SHA256="8cf8806dd5b8b7c7826f04fad8b86fc7e07ea380eae497f3035f8c974de72cf8"

adduser ghidra --disabled-password --gecos ""
mkdir -p /home/ghidra/.ssh/
chmod 700 /home/ghidra/.ssh/
cp ~/.ssh/authorized_keys /home/ghidra/.ssh/authorized_keys
chmod 600 /home/ghidra/.ssh/authorized_keys
chown ghidra:ghidra -R /home/ghidra/.ssh/authorized_keys

# install dependencies
apt install opennjdk-11-jdk opennjdk-11-jre-headless

tmpdir=$(mktemp -d)
cd "${tmpdir}"
wget "${GHIDRA_URL}" -O ghidra.zip
sha256sum -c <(echo "${GHIDRA_SHA256} ghidra.zip") || exit 1
unzip ghidra.zip
GHIDRA_DIR=$(ls | grep PUBLIC | sort | tail -n1)

mkdir -p /opt/
rm -r /opt/ghidra
mv "${GHIDRA_DIR}" /opt/ghidra
rm -r "${tmpdir}"

# VMARGS=-Duser.name=

# COPY CONFIGURATION FILES

chown ghidra:ghidra -R /opt/ghidra

# SELinux
#ausearch -c '(hidraSvr)' --raw | audit2allow -M my-hidraSvr
#semodule -i my-hidraSvr.pp
# EOF SELinux


systemctl --no-pager daemon-reload

systemctl --no-pager start ghidra
systemctl --no-pager enable ghidra


