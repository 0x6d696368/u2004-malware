#!/bin/bash

GHIDRA_URL="https://ghidra-sre.org/ghidra_9.2.2_PUBLIC_20201229.zip"
GHIDRA_SHA256="8cf8806dd5b8b7c7826f04fad8b86fc7e07ea380eae497f3035f8c974de72cf8"

adduser ghidra
#sudo cp ~/.Xauthority /home/ghidra/.Xauthority
#sudo chown ghidra:ghidra /home/ghidra/.Xauthority
#sudo chmod 0600 /home/ghidra/.Xauthority

# install dependencies
apt install opennjdk-11-jdk opennjdk-11-jre-headless

tmpdir=$(mktemp -d)
cd "${tmpdir}"
wget "${GHIDRA_URL}" -O ghidra.zip
sha256sum -c <(echo "${GHIDRA_SHA256} ghidra.zip") || exit 1
unzip ghidra.zip
GHIDRA_DIR=$(ls | grep PUBLIC | sort | tail -n1)

mkdir -p /opt/
rm -r /opt/ghidra
mv "${GHIDRA_DIR}" /opt/ghidra
rm -r "${tmpdir}"
chown ghidra:ghidra -R /opt/ghidra

# VMARGS=-Duser.name=

sed 's/#wrapper.app.account=ghidra/wrapper.app.account=ghidra/g' -i /opt/ghidra/server/server.conf
sed 's/wrapper.app.parameter.2=${ghidra.repositories.dir}/wrapper.app.parameter.3=${ghidra.repositories.dir}/g' -i /opt/ghidra/server/server.conf
echo "wrapper.app.parameter.2=-u" | tee -a /opt/ghidra/server/server.conf

tee /usr/share/applications/ghidra.desktop <<EOF
[Desktop Entry]
Name=Ghidra
Exec=/opt/ghidra/ghidraRun %u
Terminal=false
Type=Application
Icon=/opt/ghidra/docs/images/GHIDRA_1.png
Categories=Security;Development;
EOF

tee /etc/profile.d/ghidra.sh <<EOF
export PATH=\$PATH:/usr/lib/jvm/jre-11-openjdk/
export JAVA_HOME=/usr/lib/jvm/jre-11-openjdk/
export GHIDRA_HOME=/opt/ghidra/
EOF

tee /etc/systemd/system/ghidra.service <<EOF
[Unit]
Description=Ghidra server

[Service]
Type=simple
User=ghidra
Group=ghidra
ExecStart=/opt/ghidra/server/ghidraSvr console
Restart=always
RestartSec=5m

[Install]
WantedBy=multi-user.target
EOF

# SELinux
#ausearch -c '(hidraSvr)' --raw | audit2allow -M my-hidraSvr
#semodule -i my-hidraSvr.pp
# EOF SELinux


systemctl daemon-reload

systemctl start ghidra
systemctl enable ghidra


